<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Finanzas Personales</title>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <!-- SheetJS para Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
/* ========================================
   Variables y Reset
   ======================================== */
:root {
    --primary-color: #667eea;
    --primary-dark: #5568d3;
    --secondary-color: #764ba2;
    --success-color: #48bb78;
    --danger-color: #f56565;
    --warning-color: #ed8936;
    --info-color: #4299e1;
    
    --bg-color: #f7fafc;
    --card-bg: #ffffff;
    --text-primary: #2d3748;
    --text-secondary: #718096;
    --border-color: #e2e8f0;
    
    --income-color: #48bb78;
    --expense-color: #f56565;
    --balance-color: #667eea;
    
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    
    --radius-sm: 6px;
    --radius-md: 12px;
    --radius-lg: 16px;
    
    --transition: all 0.3s ease;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg-color);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* ========================================
   Container
   ======================================== */
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px;
    width: 100%;
}

/* ========================================
   Notificaciones
   ======================================== */
.notifications-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 400px;
}

.notification {
    background: white;
    padding: 16px 20px;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.3s ease;
    border-left: 4px solid var(--info-color);
}

.notification.success {
    border-left-color: var(--success-color);
}

.notification.error {
    border-left-color: var(--danger-color);
}

.notification.warning {
    border-left-color: var(--warning-color);
}

.notification i {
    font-size: 20px;
}

.notification.success i {
    color: var(--success-color);
}

.notification.error i {
    color: var(--danger-color);
}

.notification.warning i {
    color: var(--warning-color);
}

.notification.info i {
    color: var(--info-color);
}

.notification-content {
    flex: 1;
}

.notification-content p {
    margin: 0;
    font-size: 14px;
    font-weight: 500;
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* ========================================
   Header
   ======================================== */
.header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 20px 0;
    box-shadow: var(--shadow-md);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 24px;
    font-weight: 700;
}

.logo i {
    font-size: 28px;
}

.header-actions {
    display: flex;
    gap: 10px;
}

/* ========================================
   Tabs Navigation
   ======================================== */
.tabs-navigation {
    background: white;
    border-bottom: 2px solid var(--border-color);
    box-shadow: var(--shadow-sm);
    position: sticky;
    top: 0;
    z-index: 100;
}

.tabs {
    display: flex;
    gap: 0;
    overflow-x: auto;
    scrollbar-width: none;
}

.tabs::-webkit-scrollbar {
    display: none;
}

.tab-btn {
    background: none;
    border: none;
    padding: 16px 24px;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: var(--transition);
    border-bottom: 3px solid transparent;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tab-btn i {
    font-size: 16px;
}

.tab-btn:hover {
    color: var(--primary-color);
    background: rgba(102, 126, 234, 0.05);
}

.tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.05);
}

/* ========================================
   Main Content
   ======================================== */
.main-content {
    flex: 1;
    padding: 30px 0;
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ========================================
   Sections
   ======================================== */
section {
    margin-bottom: 40px;
}

.section-header {
    margin-bottom: 24px;
}

.section-header h2 {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
}

.section-header p {
    color: var(--text-secondary);
    font-size: 15px;
    margin-left: 40px;
}

/* ========================================
   Upload Area
   ======================================== */
.upload-section {
    margin-bottom: 30px;
}

.upload-area {
    background: white;
    border: 3px dashed var(--border-color);
    border-radius: var(--radius-lg);
    padding: 60px 40px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
}

.upload-area:hover {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.02);
}

.upload-area.drag-over {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.1);
    transform: scale(1.02);
}

.upload-area i {
    font-size: 64px;
    color: var(--primary-color);
    margin-bottom: 20px;
}

.upload-area h3 {
    font-size: 22px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 10px;
}

.upload-area p {
    color: var(--text-secondary);
    margin: 10px 0;
}

.upload-hint {
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 15px;
}

/* ========================================
   Buttons
   ======================================== */
.btn {
    padding: 12px 24px;
    border: none;
    border-radius: var(--radius-md);
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    font-family: inherit;
}

.btn i {
    font-size: 16px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-secondary {
    background: var(--text-secondary);
    color: white;
}

.btn-secondary:hover {
    background: var(--text-primary);
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    background: #e53e3e;
}

.btn-success {
    background: var(--success-color);
    color: white;
}

.btn-success:hover {
    background: #38a169;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 14px;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* ========================================
   Summary Cards
   ======================================== */
.summary-cards, .summary-section, .income-summary, .expenses-summary, .month-summary, .rules-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.summary-card {
    background: white;
    border-radius: var(--radius-lg);
    padding: 24px;
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: var(--transition);
}

.summary-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.card-icon {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    flex-shrink: 0;
}

.summary-card.balance .card-icon {
    background: linear-gradient(135deg, var(--balance-color) 0%, var(--secondary-color) 100%);
}

.summary-card.income .card-icon {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
}

.summary-card.expense .card-icon {
    background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
}

.summary-card.transactions .card-icon {
    background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
}

.summary-card:not(.balance):not(.income):not(.expense):not(.transactions) .card-icon {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
}

.card-content {
    flex: 1;
}

.card-label {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.card-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
}

/* ========================================
   Charts
   ======================================== */
.charts-section {
    margin-bottom: 30px;
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 24px;
    margin-bottom: 30px;
}

.chart-card {
    background: white;
    border-radius: var(--radius-lg);
    padding: 24px;
    box-shadow: var(--shadow-sm);
}

.chart-card h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.chart-container {
    position: relative;
}

/* ========================================
   Month Selector
   ======================================== */
.month-selector-card {
    background: white;
    border-radius: var(--radius-lg);
    padding: 20px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 24px;
}

.selector-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

.form-select {
    padding: 10px 16px;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
    background: white;
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
}

.form-select:hover {
    border-color: var(--primary-color);
}

.form-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* ========================================
   Rules Section
   ======================================== */
.rules-actions {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
}

.info-card {
    background: #ebf8ff;
    border: 2px solid #bee3f8;
    border-radius: var(--radius-lg);
    padding: 24px;
    margin-top: 24px;
}

.info-card h4 {
    font-size: 18px;
    font-weight: 600;
    color: var(--info-color);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.info-card ul {
    list-style: none;
    padding: 0;
}

.info-card li {
    padding: 8px 0;
    color: var(--text-primary);
    line-height: 1.6;
}

.info-card li strong {
    color: var(--info-color);
}

/* ========================================
   Filters
   ======================================== */
.filters-card {
    background: white;
    border-radius: var(--radius-lg);
    padding: 20px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 20px;
}

.filters-row {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
}

.search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
}

.search-box i {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
}

.search-box input {
    width: 100%;
    padding: 10px 16px 10px 40px;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    font-size: 15px;
    transition: var(--transition);
    font-family: inherit;
}

.search-box input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.filter-info {
    margin-top: 12px;
    color: var(--text-secondary);
    font-size: 14px;
}

/* ========================================
   Tables
   ======================================== */
.table-card {
    background: white;
    border-radius: var(--radius-lg);
    padding: 24px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 24px;
}

.table-card h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.table-responsive {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead {
    background: var(--bg-color);
}

.data-table th {
    padding: 14px 16px;
    text-align: left;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
}

.data-table th:hover {
    background: var(--border-color);
}

.data-table th i {
    margin-left: 4px;
    font-size: 12px;
}

.data-table td {
    padding: 14px 16px;
    border-top: 1px solid var(--border-color);
    font-size: 14px;
}

.data-table tbody tr {
    transition: var(--transition);
}

.data-table tbody tr:hover {
    background: rgba(102, 126, 234, 0.02);
}

.data-table .empty-state {
    text-align: center;
    color: var(--text-secondary);
    font-style: italic;
    padding: 40px !important;
}

/* ========================================
   Transaction Types
   ======================================== */
.amount-income {
    color: var(--income-color);
    font-weight: 600;
}

.amount-expense {
    color: var(--expense-color);
    font-weight: 600;
}

.category-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    font-size: 13px;
    font-weight: 500;
    background: var(--bg-color);
    color: var(--text-primary);
    cursor: pointer;
    transition: var(--transition);
}

.category-badge:hover {
    background: var(--border-color);
}

.category-badge i {
    font-size: 14px;
}

/* ========================================
   Category Editor (Inline)
   ======================================== */
.category-editor {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    animation: fadeIn 0.2s ease;
}

.editor-content {
    background: white;
    border-radius: var(--radius-lg);
    padding: 30px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
}

.editor-content h4 {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--text-primary);
}

.editor-description {
    padding: 12px;
    background: var(--bg-color);
    border-radius: var(--radius-md);
    margin-bottom: 20px;
    font-size: 14px;
    color: var(--text-secondary);
}

.editor-categories {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
}

.editor-category-btn {
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    background: white;
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
    text-align: left;
}

.editor-category-btn:hover {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.05);
}

.editor-category-btn i {
    font-size: 16px;
}

.editor-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

/* ========================================
   Action Buttons in Tables
   ======================================== */
.action-btn {
    background: none;
    border: none;
    padding: 6px 10px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition);
    color: var(--text-secondary);
    font-size: 14px;
}

.action-btn:hover {
    background: var(--bg-color);
    color: var(--primary-color);
}

.action-btn.delete:hover {
    color: var(--danger-color);
}

/* ========================================
   Footer
   ======================================== */
.footer {
    background: white;
    border-top: 1px solid var(--border-color);
    padding: 20px 0;
    margin-top: auto;
}

.footer p {
    text-align: center;
    color: var(--text-secondary);
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.footer i {
    color: var(--success-color);
}

/* ========================================
   Responsive
   ======================================== */
@media (max-width: 1024px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        gap: 16px;
        text-align: center;
    }
    
    .logo {
        font-size: 20px;
    }
    
    .tab-btn span {
        display: none;
    }
    
    .tab-btn {
        padding: 16px;
        justify-content: center;
    }
    
    .summary-cards, .income-summary, .expenses-summary, .month-summary, .rules-summary {
        grid-template-columns: 1fr;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .filters-row {
        flex-direction: column;
    }
    
    .search-box {
        width: 100%;
    }
    
    .btn-text {
        display: none;
    }
    
    .section-header h2 {
        font-size: 22px;
    }
    
    .section-header p {
        margin-left: 0;
        font-size: 14px;
    }
    
    .upload-area {
        padding: 40px 20px;
    }
    
    .editor-categories {
        grid-template-columns: 1fr;
    }
    
    .selector-controls {
        flex-wrap: wrap;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 0 12px;
    }
    
    .main-content {
        padding: 20px 0;
    }
    
    .chart-card, .table-card, .filters-card {
        padding: 16px;
    }
    
    .summary-card {
        padding: 16px;
    }
    
    .card-value {
        font-size: 24px;
    }
}

/* ========================================
   Utilities
   ======================================== */
.text-center {
    text-align: center;
}

.mt-2 {
    margin-top: 16px;
}

.mb-2 {
    margin-bottom: 16px;
}

.hidden {
    display: none !important;
}

/* ========================================
   Loading Spinner
   ======================================== */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}
    </style>
</head>
<body>
    <!-- Notificaciones -->
    <div id="notifications" class="notifications-container"></div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <span>Finanzas Personales</span>
                </div>
                <div class="header-actions">
                    <button id="clearDataBtn" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i>
                        <span class="btn-text">Borrar Datos</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Navigation Tabs -->
    <nav class="tabs-navigation">
        <div class="container">
            <div class="tabs">
                <button class="tab-btn active" data-tab="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </button>
                <button class="tab-btn" data-tab="ingresos">
                    <i class="fas fa-arrow-up"></i>
                    <span>Ingresos</span>
                </button>
                <button class="tab-btn" data-tab="gastos">
                    <i class="fas fa-arrow-down"></i>
                    <span>Gastos</span>
                </button>
                <button class="tab-btn" data-tab="balance">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Balance Mensual</span>
                </button>
                <button class="tab-btn" data-tab="reglas">
                    <i class="fas fa-cogs"></i>
                    <span>Reglas</span>
                </button>
                <button class="tab-btn" data-tab="transacciones">
                    <i class="fas fa-list"></i>
                    <span>Transacciones</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            
            <!-- TAB: Dashboard -->
            <div id="tab-dashboard" class="tab-content active">
                <!-- Upload Area -->
                <section class="upload-section">
                    <div class="section-header">
                        <h2><i class="fas fa-upload"></i> Cargar Movimientos Bancarios</h2>
                        <p>Arrastra archivos CSV o Excel de tus bancos</p>
                    </div>
                    <div id="uploadArea" class="upload-area">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>Arrastra archivos aquí</h3>
                        <p>o</p>
                        <button id="selectFileBtn" class="btn btn-primary">
                            <i class="fas fa-folder-open"></i> Seleccionar Archivos
                        </button>
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" multiple hidden>
                        <p class="upload-hint">Acepta CSV, Excel (.xlsx, .xls) • Múltiples bancos</p>
                    </div>
                </section>

                <!-- Summary Cards -->
                <section class="summary-section">
                    <div class="summary-cards">
                        <div class="summary-card balance">
                            <div class="card-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Balance Total</p>
                                <p class="card-value" id="totalBalance">€0.00</p>
                            </div>
                        </div>
                        <div class="summary-card income">
                            <div class="card-icon">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Ingresos Totales</p>
                                <p class="card-value" id="totalIncome">€0.00</p>
                            </div>
                        </div>
                        <div class="summary-card expense">
                            <div class="card-icon">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Gastos Totales</p>
                                <p class="card-value" id="totalExpense">€0.00</p>
                            </div>
                        </div>
                        <div class="summary-card transactions">
                            <div class="card-icon">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Transacciones</p>
                                <p class="card-value" id="totalTransactions">0</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Charts Section -->
                <section class="charts-section">
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-bar"></i> Ingresos vs Gastos Mensuales</h3>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-pie"></i> Gastos por Categoría</h3>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-line"></i> Tendencia de Balance</h3>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="balanceChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-bar"></i> Top 10 Categorías</h3>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="topCategoriesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- TAB: Ingresos -->
            <div id="tab-ingresos" class="tab-content">
                <section class="income-section">
                    <div class="section-header">
                        <h2><i class="fas fa-arrow-up"></i> Análisis de Ingresos</h2>
                        <p>Tus fuentes de ingreso agrupadas y analizadas</p>
                    </div>

                    <!-- Income Summary -->
                    <div class="income-summary">
                        <div class="summary-card income">
                            <div class="card-icon">
                                <i class="fas fa-euro-sign"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Ingresos Totales</p>
                                <p class="card-value" id="incomeTotal">€0.00</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="card-icon">
                                <i class="fas fa-stream"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Fuentes de Ingreso</p>
                                <p class="card-value" id="incomeSources">0</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="card-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Ingreso Promedio Mensual</p>
                                <p class="card-value" id="incomeAverage">€0.00</p>
                            </div>
                        </div>
                    </div>

                    <!-- Income Charts -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-pie"></i> Ingresos por Fuente</h3>
                            <div class="chart-container" style="height: 400px;">
                                <canvas id="incomeSourcesChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-line"></i> Evolución de Ingresos Mensuales</h3>
                            <div class="chart-container" style="height: 400px;">
                                <canvas id="incomeEvolutionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Income by Source Table -->
                    <div class="table-card">
                        <h3><i class="fas fa-table"></i> Detalle por Fuente de Ingreso</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="incomeSourcesTable">
                                <thead>
                                    <tr>
                                        <th>Fuente</th>
                                        <th>Total</th>
                                        <th>Transacciones</th>
                                        <th>Promedio</th>
                                        <th>Última Fecha</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="empty-state">
                                        <td colspan="5">No hay datos de ingresos</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- All Income Transactions -->
                    <div class="table-card">
                        <h3><i class="fas fa-list"></i> Todas las Transacciones de Ingresos</h3>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
                            Haz clic en cualquier categoría para recategorizarla
                        </p>
                        <div class="table-responsive">
                            <table class="data-table" id="allIncomeTransactionsTable">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Descripción</th>
                                        <th>Categoría</th>
                                        <th>Importe</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="empty-state">
                                        <td colspan="5">No hay transacciones de ingresos</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>

            <!-- TAB: Gastos -->
            <div id="tab-gastos" class="tab-content">
                <section class="expenses-section">
                    <div class="section-header">
                        <h2><i class="fas fa-arrow-down"></i> Análisis de Gastos</h2>
                        <p>Tus gastos categorizados y analizados</p>
                    </div>

                    <!-- Expenses Summary -->
                    <div class="expenses-summary">
                        <div class="summary-card expense">
                            <div class="card-icon">
                                <i class="fas fa-euro-sign"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Gastos Totales</p>
                                <p class="card-value" id="expensesTotal">€0.00</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="card-icon">
                                <i class="fas fa-tags"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Categorías Activas</p>
                                <p class="card-value" id="expensesCategories">0</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="card-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Gasto Promedio Mensual</p>
                                <p class="card-value" id="expensesAverage">€0.00</p>
                            </div>
                        </div>
                    </div>

                    <!-- Expenses Charts -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-pie"></i> Gastos por Categoría</h3>
                            <div class="chart-container" style="height: 400px;">
                                <canvas id="expensesCategoryChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-line"></i> Evolución de Gastos Mensuales</h3>
                            <div class="chart-container" style="height: 400px;">
                                <canvas id="expensesEvolutionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Expenses by Category Table -->
                    <div class="table-card">
                        <h3><i class="fas fa-table"></i> Detalle por Categoría</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="expensesCategoriesTable">
                                <thead>
                                    <tr>
                                        <th>Categoría</th>
                                        <th>Total</th>
                                        <th>Transacciones</th>
                                        <th>Promedio</th>
                                        <th>% del Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="empty-state">
                                        <td colspan="5">No hay datos de gastos</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- All Expense Transactions -->
                    <div class="table-card">
                        <h3><i class="fas fa-list"></i> Todas las Transacciones de Gastos</h3>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
                            Haz clic en cualquier categoría para recategorizarla
                        </p>
                        <div class="table-responsive">
                            <table class="data-table" id="allExpenseTransactionsTable">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Descripción</th>
                                        <th>Categoría</th>
                                        <th>Importe</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="empty-state">
                                        <td colspan="5">No hay transacciones de gastos</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>

            <!-- TAB: Balance Mensual -->
            <div id="tab-balance" class="tab-content">
                <section class="balance-section">
                    <div class="section-header">
                        <h2><i class="fas fa-calendar-alt"></i> Balance Mensual</h2>
                        <p>Análisis detallado mes a mes</p>
                    </div>

                    <!-- Month Selector -->
                    <div class="month-selector-card">
                        <div class="selector-controls">
                            <button id="prevMonth" class="btn btn-secondary btn-sm">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <select id="monthSelect" class="form-select"></select>
                            <select id="yearSelect" class="form-select"></select>
                            <button id="nextMonth" class="btn btn-secondary btn-sm">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Selected Month Summary -->
                    <div id="selectedMonthSummary" class="month-summary">
                        <div class="summary-card income">
                            <div class="card-icon">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Ingresos del Mes</p>
                                <p class="card-value" id="monthIncome">€0.00</p>
                            </div>
                        </div>
                        <div class="summary-card expense">
                            <div class="card-icon">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Gastos del Mes</p>
                                <p class="card-value" id="monthExpense">€0.00</p>
                            </div>
                        </div>
                        <div class="summary-card balance">
                            <div class="card-icon">
                                <i class="fas fa-balance-scale"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Balance Neto</p>
                                <p class="card-value" id="monthBalance">€0.00</p>
                            </div>
                        </div>
                        <div class="summary-card transactions">
                            <div class="card-icon">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Transacciones</p>
                                <p class="card-value" id="monthTransactions">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Evolution Chart -->
                    <div class="chart-card">
                        <h3><i class="fas fa-chart-line"></i> Evolución Mensual</h3>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="monthlyEvolutionChart"></canvas>
                        </div>
                    </div>

                    <!-- All Months Summary Table -->
                    <div class="table-card">
                        <h3><i class="fas fa-table"></i> Resumen de Todos los Meses</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="allMonthsTable">
                                <thead>
                                    <tr>
                                        <th>Mes</th>
                                        <th>Ingresos</th>
                                        <th>Gastos</th>
                                        <th>Balance</th>
                                        <th>Transacciones</th>
                                        <th>Ahorro %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="empty-state">
                                        <td colspan="6">No hay datos mensuales</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>

            <!-- TAB: Reglas -->
            <div id="tab-reglas" class="tab-content">
                <section class="rules-section">
                    <div class="section-header">
                        <h2><i class="fas fa-cogs"></i> Gestión de Reglas de Categorización</h2>
                        <p>Las reglas automatizan la categorización de tus transacciones futuras</p>
                    </div>

                    <!-- Rules Summary -->
                    <div class="rules-summary">
                        <div class="summary-card">
                            <div class="card-icon">
                                <i class="fas fa-list"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Reglas Activas</p>
                                <p class="card-value" id="activeRulesCount">0</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="card-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Aplicaciones Totales</p>
                                <p class="card-value" id="rulesApplications">0</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="card-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="card-content">
                                <p class="card-label">Última Actualización</p>
                                <p class="card-value" id="lastRuleUpdate">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Rules Actions -->
                    <div class="rules-actions">
                        <button id="applyRulesBtn" class="btn btn-primary">
                            <i class="fas fa-play"></i> Aplicar Reglas a Todas las Transacciones
                        </button>
                        <button id="clearRulesBtn" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Borrar Todas las Reglas
                        </button>
                    </div>

                    <!-- Rules Table -->
                    <div class="table-card">
                        <h3><i class="fas fa-table"></i> Reglas Configuradas</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="rulesTable">
                                <thead>
                                    <tr>
                                        <th>Patrón de Búsqueda</th>
                                        <th>Categoría</th>
                                        <th>Creada</th>
                                        <th>Aplicaciones</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="empty-state">
                                        <td colspan="5">
                                            No hay reglas configuradas. 
                                            <br>
                                            <small>Las reglas se crean automáticamente cuando categorizas transacciones en la pestaña de Transacciones.</small>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Rules Info -->
                    <div class="info-card">
                        <h4><i class="fas fa-info-circle"></i> Cómo funcionan las reglas</h4>
                        <ul>
                            <li><strong>Creación automática:</strong> Cuando categorizas manualmente una transacción en la pestaña "Transacciones", se crea automáticamente una regla para esa descripción.</li>
                            <li><strong>Aplicación automática:</strong> Las reglas se aplican automáticamente cuando cargas nuevos archivos bancarios.</li>
                            <li><strong>Patrones inteligentes:</strong> Las reglas buscan coincidencias en las descripciones de las transacciones.</li>
                            <li><strong>Gestión flexible:</strong> Puedes ver, editar o eliminar reglas individuales desde esta pantalla.</li>
                            <li><strong>Reaplicación:</strong> Usa el botón "Aplicar Reglas" para recategorizar todas tus transacciones existentes.</li>
                        </ul>
                    </div>
                </section>
            </div>

            <!-- TAB: Transacciones -->
            <div id="tab-transacciones" class="tab-content">
                <section class="transactions-section">
                    <div class="section-header">
                        <h2><i class="fas fa-list"></i> Todas las Transacciones</h2>
                        <p>Gestiona y categoriza tus transacciones</p>
                    </div>

                    <!-- Filters and Search -->
                    <div class="filters-card">
                        <div class="filters-row">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchInput" placeholder="Buscar por descripción, importe...">
                            </div>
                            <select id="categoryFilter" class="form-select">
                                <option value="">Todas las categorías</option>
                            </select>
                            <select id="typeFilter" class="form-select">
                                <option value="">Todos los tipos</option>
                                <option value="income">Ingresos</option>
                                <option value="expense">Gastos</option>
                            </select>
                            <button id="exportBtn" class="btn btn-secondary">
                                <i class="fas fa-download"></i>
                                <span class="btn-text">Exportar CSV</span>
                            </button>
                        </div>
                        <div class="filter-info">
                            <span id="filterInfo">Mostrando 0 transacciones</span>
                        </div>
                    </div>

                    <!-- Transactions Table -->
                    <div class="table-card">
                        <div class="table-responsive">
                            <table class="data-table" id="transactionsTable">
                                <thead>
                                    <tr>
                                        <th data-sort="date">
                                            Fecha 
                                            <i class="fas fa-sort"></i>
                                        </th>
                                        <th data-sort="description">
                                            Descripción 
                                            <i class="fas fa-sort"></i>
                                        </th>
                                        <th data-sort="category">
                                            Categoría 
                                            <i class="fas fa-sort"></i>
                                        </th>
                                        <th data-sort="amount">
                                            Importe 
                                            <i class="fas fa-sort"></i>
                                        </th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="empty-state">
                                        <td colspan="5">
                                            No hay transacciones. Carga archivos en la pestaña Dashboard.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Inline Category Editor (Hidden by default) -->
                    <div id="categoryEditor" class="category-editor" style="display: none;">
                        <div class="editor-content">
                            <h4>Categorizar Transacción</h4>
                            <p class="editor-description" id="editorDescription"></p>
                            <div class="editor-categories" id="editorCategories"></div>
                            <div class="editor-actions">
                                <button id="cancelEditBtn" class="btn btn-secondary btn-sm">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>
                <i class="fas fa-shield-alt"></i> 
                Tus datos se procesan localmente en tu navegador. 
                No se envía nada a servidores externos.
            </p>
        </div>
    </footer>

    <script>
// ============================================
// CATEGORIES.JS
// ============================================
const CATEGORIES = {
    'Supermercado': { icon: 'fa-shopping-cart', color: '#48bb78', keywords: ['mercadona', 'carrefour', 'dia', 'lidl', 'aldi', 'eroski', 'alcampo', 'hipercor', 'supermercado', 'super', 'consum'] },
    'Restaurantes': { icon: 'fa-utensils', color: '#ed8936', keywords: ['restaurante', 'bar ', 'cafeteria', 'mcdonalds', 'burger', 'pizza', 'telepizza', 'dominos', 'kfc', 'vips', 'ginos'] },
    'Comida Rápida': { icon: 'fa-hamburger', color: '#f56565', keywords: ['just eat', 'glovo', 'uber eats', 'deliveroo', 'mcdonalds', 'burger king', 'kebab'] },
    'Transporte Público': { icon: 'fa-bus', color: '#4299e1', keywords: ['metro', 'renfe', 'cercanias', 'bus', 'emt', 'tmb', 'abono transporte', 'tarjeta transporte'] },
    'Gasolina': { icon: 'fa-gas-pump', color: '#38b2ac', keywords: ['repsol', 'cepsa', 'galp', 'bp', 'shell', 'gasolinera', 'combustible', 'gasolina'] },
    'Taxi': { icon: 'fa-taxi', color: '#ecc94b', keywords: ['taxi', 'cabify', 'uber', 'free now'] },
    'Parking': { icon: 'fa-parking', color: '#a0aec0', keywords: ['parking', 'aparcamiento', 'parkia', 'saba'] },
    'Alquiler': { icon: 'fa-home', color: '#667eea', keywords: ['alquiler', 'renta', 'arrendamiento', 'inmobiliaria'] },
    'Hipoteca': { icon: 'fa-university', color: '#805ad5', keywords: ['hipoteca', 'prestamo hipotecario', 'cuota hipoteca'] },
    'Suministros': { icon: 'fa-bolt', color: '#ed64a6', keywords: ['iberdrola', 'endesa', 'naturgy', 'luz', 'gas', 'agua', 'electricidad', 'suministro'] },
    'Internet y Teléfono': { icon: 'fa-wifi', color: '#4299e1', keywords: ['movistar', 'vodafone', 'orange', 'jazztel', 'yoigo', 'masmovil', 'fibra', 'adsl', 'telefono', 'movil'] },
    'Comunidad': { icon: 'fa-building', color: '#718096', keywords: ['comunidad', 'gastos comunes', 'administrador', 'finca'] },
    'Ropa y Calzado': { icon: 'fa-tshirt', color: '#ed8936', keywords: ['zara', 'h&m', 'mango', 'pull&bear', 'bershka', 'stradivarius', 'massimo dutti', 'primark', 'decathlon', 'nike', 'adidas', 'ropa', 'calzado'] },
    'Hogar y Muebles': { icon: 'fa-couch', color: '#9f7aea', keywords: ['ikea', 'leroy merlin', 'aki', 'bricomart', 'brico depot', 'muebles', 'hogar', 'decoracion'] },
    'Tecnología': { icon: 'fa-laptop', color: '#4299e1', keywords: ['amazon', 'fnac', 'mediamarkt', 'pccomponentes', 'apple', 'samsung', 'tecnologia', 'electronica'] },
    'Farmacia': { icon: 'fa-pills', color: '#48bb78', keywords: ['farmacia', 'parafarmacia', 'medicamento'] },
    'Salud': { icon: 'fa-heartbeat', color: '#f56565', keywords: ['medico', 'hospital', 'clinica', 'dentista', 'odontologo', 'seguro medico', 'sanitas', 'adeslas', 'asisa'] },
    'Gimnasio': { icon: 'fa-dumbbell', color: '#ed8936', keywords: ['gimnasio', 'gym', 'fitness', 'sport', 'deportivo', 'piscina'] },
    'Peluquería': { icon: 'fa-cut', color: '#9f7aea', keywords: ['peluqueria', 'barberia', 'salon', 'estetica'] },
    'Ocio': { icon: 'fa-film', color: '#f687b3', keywords: ['cine', 'teatro', 'museo', 'concierto', 'entrada', 'ocio'] },
    'Streaming': { icon: 'fa-play-circle', color: '#e53e3e', keywords: ['netflix', 'hbo', 'amazon prime', 'disney', 'spotify', 'youtube premium', 'dazn', 'movistar+'] },
    'Viajes': { icon: 'fa-plane', color: '#38b2ac', keywords: ['hotel', 'booking', 'airbnb', 'vuelo', 'ryanair', 'vueling', 'iberia', 'viaje', 'hostal'] },
    'Libros': { icon: 'fa-book', color: '#805ad5', keywords: ['libreria', 'casa del libro', 'libro', 'fnac'] },
    'Seguros': { icon: 'fa-shield-alt', color: '#4299e1', keywords: ['seguro', 'mapfre', 'mutua', 'axa', 'allianz', 'generali', 'santalucia'] },
    'Seguro Coche': { icon: 'fa-car', color: '#4299e1', keywords: ['seguro coche', 'seguro vehiculo', 'seguro auto'] },
    'Educación': { icon: 'fa-graduation-cap', color: '#9f7aea', keywords: ['colegio', 'universidad', 'academia', 'curso', 'formacion', 'matricula', 'educacion'] },
    'Mascotas': { icon: 'fa-paw', color: '#ed8936', keywords: ['veterinario', 'mascota', 'kiwoko', 'tiendanimal', 'pienso', 'perro', 'gato'] },
    'Impuestos': { icon: 'fa-file-invoice-dollar', color: '#e53e3e', keywords: ['hacienda', 'agencia tributaria', 'impuesto', 'iva', 'irpf', 'tasa', 'multa'] },
    'Ahorro': { icon: 'fa-piggy-bank', color: '#48bb78', keywords: ['ahorro', 'deposito', 'inversion', 'fondo'] },
    'Transferencia': { icon: 'fa-exchange-alt', color: '#4299e1', keywords: ['transferencia', 'bizum', 'traspaso'] },
    'Nómina': { icon: 'fa-money-bill-wave', color: '#48bb78', keywords: ['nomina', 'salario', 'sueldo', 'paga'] },
    'Venta': { icon: 'fa-hand-holding-usd', color: '#38b2ac', keywords: ['venta', 'ingreso venta', 'wallapop', 'vinted'] },
    'Reembolso': { icon: 'fa-undo', color: '#4299e1', keywords: ['devolucion', 'reembolso', 'reintegro'] },
    'Préstamos': { icon: 'fa-hand-holding-usd', color: '#ed8936', keywords: ['prestamo', 'credito', 'financiacion'] },
    'Donaciones': { icon: 'fa-donate', color: '#ed64a6', keywords: ['donacion', 'caridad', 'ong', 'unicef', 'cruz roja'] },
    'Suscripciones': { icon: 'fa-sync-alt', color: '#9f7aea', keywords: ['suscripcion', 'mensualidad', 'cuota'] },
    'Cajero': { icon: 'fa-credit-card', color: '#718096', keywords: ['cajero', 'retirada', 'efectivo'] },
    'Comisiones': { icon: 'fa-percent', color: '#e53e3e', keywords: ['comision', 'cargo', 'mantenimiento cuenta'] },
    'Otros': { icon: 'fa-question-circle', color: '#a0aec0', keywords: [] }
};

function categorizeTransaction(description) {
    const desc = description.toLowerCase();
    for (const [categoryName, categoryData] of Object.entries(CATEGORIES)) {
        for (const keyword of categoryData.keywords) {
            if (desc.includes(keyword.toLowerCase())) {
                return categoryName;
            }
        }
    }
    return 'Otros';
}

function getCategoryInfo(categoryName) {
    return CATEGORIES[categoryName] || CATEGORIES['Otros'];
}

function getAllCategories() {
    return Object.keys(CATEGORIES).sort();
}

function getAllCategoriesWithInfo() {
    return Object.entries(CATEGORIES).map(([name, info]) => ({ name, ...info })).sort((a, b) => a.name.localeCompare(b.name));
}

function determineTransactionType(amount, category) {
    const incomeCategories = ['Nómina', 'Venta', 'Reembolso', 'Ahorro'];
    if (amount > 0) return 'income';
    else if (amount < 0) return 'expense';
    else return incomeCategories.includes(category) ? 'income' : 'expense';
}

function formatIncomeSource(description) {
    const desc = description.toLowerCase();
    if (desc.includes('nomina') || desc.includes('salario')) return 'Nómina';
    else if (desc.includes('bizum') && !desc.includes('pago')) return 'Transferencias Bizum';
    else if (desc.includes('transferencia')) return 'Transferencias';
    else if (desc.includes('venta')) return 'Ventas';
    else if (desc.includes('devolucion') || desc.includes('reembolso')) return 'Devoluciones';
    else if (desc.includes('intereses')) return 'Intereses';
    return description.replace(/\d+/g, '').replace(/\s+/g, ' ').trim().substring(0, 50) || 'Otros Ingresos';
}
    </script>
    
    <script>
// ============================================
// PARSER.JS (Continúa en el siguiente script tag)
// ============================================
class BankFileParser {
    constructor() {
        this.supportedFormats = ['.csv', '.xlsx', '.xls'];
    }

    async parseFile(file) {
        const extension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
        if (extension === '.csv') {
            return await this.parseCSV(file);
        } else if (extension === '.xlsx' || extension === '.xls') {
            return await this.parseExcel(file);
        } else {
            throw new Error(`Formato no soportado: ${extension}`);
        }
    }

    async parseCSV(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const transactions = this.parseCSVText(text);
                    resolve(transactions);
                } catch (error) {
                    reject(error);
                }
            };
            reader.onerror = () => reject(new Error('Error al leer el archivo'));
            reader.readAsText(file, 'UTF-8');
        });
    }

    parseCSVText(text) {
        const lines = text.split('\n').filter(line => line.trim());
        if (lines.length < 2) throw new Error('El archivo está vacío o no tiene datos');
        const delimiter = this.detectDelimiter(lines[0]);
        const headers = this.parseCSVLine(lines[0], delimiter).map(h => h.trim().toLowerCase());
        const columns = this.identifyColumns(headers);
        if (!columns.date || !columns.description || !columns.amount) {
            throw new Error('No se pudieron identificar las columnas necesarias (fecha, descripción, importe)');
        }
        const transactions = [];
        for (let i = 1; i < lines.length; i++) {
            try {
                const values = this.parseCSVLine(lines[i], delimiter);
                if (values.length < 3) continue;
                const transaction = this.createTransaction(values, columns);
                if (transaction) transactions.push(transaction);
            } catch (error) {
                console.warn(`Error en línea ${i + 1}:`, error.message);
            }
        }
        return transactions;
    }

    async parseExcel(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellText: false });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, raw: false, dateNF: 'dd/mm/yyyy', defval: '' });
                    const filteredData = jsonData.filter(row => row && row.some(cell => cell && cell.toString().trim() !== ''));
                    console.log('📊 Datos del Excel:', filteredData.slice(0, 5));
                    const transactions = this.parseExcelData(filteredData);
                    resolve(transactions);
                } catch (error) {
                    console.error('Error parseando Excel:', error);
                    reject(error);
                }
            };
            reader.onerror = () => reject(new Error('Error al leer el archivo'));
            reader.readAsArrayBuffer(file);
        });
    }

    parseExcelData(data) {
        if (data.length < 2) throw new Error('El archivo está vacío o no tiene datos');
        let headerRowIndex = -1;
        let headers = [];
        for (let i = 0; i < Math.min(10, data.length); i++) {
            const row = data[i];
            const rowText = row.join('').toLowerCase();
            if (rowText.includes('fecha') || rowText.includes('descripci') || rowText.includes('concepto') || rowText.includes('importe') || rowText.includes('movimiento')) {
                headerRowIndex = i;
                headers = row.map(h => (h || '').toString().trim().toLowerCase());
                console.log(`✅ Encabezados encontrados en fila ${i}:`, headers);
                break;
            }
        }
        if (headerRowIndex === -1) {
            headerRowIndex = 0;
            headers = data[0].map(h => (h || '').toString().trim().toLowerCase());
            console.log('⚠️ Asumiendo primera fila como encabezado:', headers);
        }
        const columns = this.identifyColumns(headers);
        if (!columns.date && !columns.description && !columns.amount) {
            console.error('❌ No se identificaron columnas. Headers:', headers);
            throw new Error('No se pudieron identificar las columnas necesarias (fecha, descripción, importe)');
        }
        console.log('✅ Columnas identificadas:', columns);
        const transactions = [];
        for (let i = headerRowIndex + 1; i < data.length; i++) {
            try {
                const values = data[i];
                if (!values || values.length < 2) continue;
                const firstCell = (values[0] || '').toString().toLowerCase();
                if (firstCell.includes('total') || firstCell.includes('saldo') || firstCell.includes('resumen')) continue;
                const transaction = this.createTransaction(values, columns);
                if (transaction) transactions.push(transaction);
            } catch (error) {
                console.warn(`Error en fila ${i + 1}:`, error.message);
            }
        }
        if (transactions.length === 0) throw new Error('No se pudieron extraer transacciones del archivo. Verifica el formato.');
        console.log(`✅ ${transactions.length} transacciones extraídas`);
        return transactions;
    }

    detectDelimiter(line) {
        const delimiters = [',', ';', '|', '\t'];
        let maxCount = 0;
        let detectedDelimiter = ',';
        for (const delimiter of delimiters) {
            const count = (line.match(new RegExp('\\' + delimiter, 'g')) || []).length;
            if (count > maxCount) {
                maxCount = count;
                detectedDelimiter = delimiter;
            }
        }
        return detectedDelimiter;
    }

    parseCSVLine(line, delimiter) {
        const values = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            const nextChar = line[i + 1];
            if (char === '"') {
                if (inQuotes && nextChar === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === delimiter && !inQuotes) {
                values.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        values.push(current);
        return values.map(v => v.trim());
    }

    identifyColumns(headers) {
        const columns = {};
        const mappings = {
            date: ['fecha', 'date', 'fecha operacion', 'fecha operación', 'fecha valor', 'f.valor', 'f.operacion', 'f.operación', 'f. valor', 'f. operación', 'fec.', 'fecha mov', 'fecha mvto', 'fecha movimiento'],
            description: ['descripcion', 'descripción', 'concepto', 'description', 'detalle', 'movimiento', 'observaciones', 'desc.', 'concepto/movimiento', 'concepto movimiento', 'texto', 'información', 'informacion'],
            amount: ['importe', 'amount', 'cantidad', 'monto', 'cargo/abono', 'debe/haber', 'imp.', 'euros', 'eur', 'debe', 'haber', 'cargo', 'abono', 'import.', 'importe €', 'importe eur'],
            balance: ['saldo', 'balance', 'saldo final', 'saldo disponible', 'saldo actual', 'sdo.', 'disponible']
        };
        headers.forEach((header, index) => {
            const cleanHeader = header.toLowerCase().trim();
            for (const [key, variations] of Object.entries(mappings)) {
                if (variations.includes(cleanHeader)) {
                    if (!columns[key]) columns[key] = index;
                    break;
                }
                if (variations.some(v => cleanHeader.includes(v))) {
                    if (!columns[key]) columns[key] = index;
                    break;
                }
            }
        });
        if (!columns.amount) {
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase();
                if (header.includes('€') || header.includes('$') || /\d/.test(header) || header === '') {
                    columns.amount = i;
                    console.log(`ℹ️ Columna de importe detectada por contenido en posición ${i}`);
                    break;
                }
            }
        }
        return columns;
    }

    createTransaction(values, columns) {
        const dateStr = columns.date !== undefined ? values[columns.date] : null;
        const description = columns.description !== undefined ? values[columns.description] : null;
        const amountStr = columns.amount !== undefined ? values[columns.amount] : null;
        if (!dateStr && !description && !amountStr) return null;
        if (!dateStr || !description || !amountStr) {
            console.warn('⚠️ Fila incompleta:', { dateStr, description, amountStr });
            return null;
        }
        const date = this.parseDate(dateStr.toString());
        if (!date || isNaN(date.getTime())) {
            console.warn('⚠️ Fecha inválida:', dateStr);
            return null;
        }
        const amount = this.parseAmount(amountStr.toString());
        if (amount === null || isNaN(amount)) {
            console.warn('⚠️ Importe inválido:', amountStr);
            return null;
        }
        const cleanDescription = description.toString().trim();
        if (!cleanDescription) {
            console.warn('⚠️ Descripción vacía');
            return null;
        }
        const category = categorizeTransaction(cleanDescription);
        const type = determineTransactionType(amount, category);
        const incomeSource = type === 'income' ? formatIncomeSource(cleanDescription) : null;
        return {
            id: this.generateTransactionId(),
            date: date,
            description: cleanDescription,
            amount: amount,
            category: category,
            type: type,
            incomeSource: incomeSource,
            balance: columns.balance !== undefined ? this.parseAmount((values[columns.balance] || '').toString()) : null
        };
    }

    parseDate(dateStr) {
        if (!dateStr) return null;
        const str = dateStr.toString().trim();
        if (!str) return null;
        const num = parseFloat(str);
        if (!isNaN(num) && str.length <= 6 && num > 0) {
            return this.excelDateToJSDate(num);
        }
        if (dateStr instanceof Date && !isNaN(dateStr.getTime())) {
            return dateStr;
        }
        let cleaned = str.replace(/\s+/g, ' ').trim();
        const formats = [
            /^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/,
            /^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2})$/,
            /^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/,
            /^(\d{1,2})\s+(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)\s+(\d{4})$/i,
        ];
        for (let i = 0; i < formats.length; i++) {
            const format = formats[i];
            const match = cleaned.match(format);
            if (match) {
                let day, month, year;
                if (i === 3) {
                    const months = { 'enero': 0, 'febrero': 1, 'marzo': 2, 'abril': 3, 'mayo': 4, 'junio': 5, 'julio': 6, 'agosto': 7, 'septiembre': 8, 'octubre': 9, 'noviembre': 10, 'diciembre': 11 };
                    day = parseInt(match[1]);
                    month = months[match[2].toLowerCase()];
                    year = parseInt(match[3]);
                } else if (match[1].length === 4) {
                    year = parseInt(match[1]);
                    month = parseInt(match[2]) - 1;
                    day = parseInt(match[3]);
                } else {
                    day = parseInt(match[1]);
                    month = parseInt(match[2]) - 1;
                    year = parseInt(match[3]);
                    if (year < 100) {
                        year += (year < 50) ? 2000 : 1900;
                    }
                }
                const date = new Date(year, month, day);
                if (!isNaN(date.getTime()) && date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
                    return date;
                }
            }
        }
        try {
            const date = new Date(cleaned);
            if (!isNaN(date.getTime()) && date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
                return date;
            }
        } catch (e) {}
        return null;
    }

    excelDateToJSDate(excelDate) {
        const date = new Date((excelDate - 25569) * 86400 * 1000);
        return date;
    }

    parseAmount(amountStr) {
        if (!amountStr) return null;
        let str = amountStr.toString().trim();
        if (!str) return null;
        const directNum = parseFloat(amountStr);
        if (!isNaN(directNum) && str.match(/^-?\d+\.?\d*$/)) {
            return directNum;
        }
        let isNegative = false;
        if (str.startsWith('-') || str.startsWith('(') || str.toLowerCase().includes('debe')) {
            isNegative = true;
        }
        let cleaned = str.replace(/[€$£¥]/g, '').replace(/[\s]/g, '').replace(/[()]/g, '').replace(/debe|haber|dr|cr/gi, '').trim();
        if (!cleaned || cleaned === '-') return null;
        const hasComma = cleaned.includes(',');
        const hasDot = cleaned.includes('.');
        if (hasComma && hasDot) {
            const lastComma = cleaned.lastIndexOf(',');
            const lastDot = cleaned.lastIndexOf('.');
            if (lastComma > lastDot) {
                cleaned = cleaned.replace(/\./g, '').replace(',', '.');
            } else {
                cleaned = cleaned.replace(/,/g, '');
            }
        } else if (hasComma) {
            const parts = cleaned.split(',');
            if (parts.length === 2 && parts[1].length <= 2) {
                cleaned = cleaned.replace(',', '.');
            } else {
                cleaned = cleaned.replace(/,/g, '');
            }
        } else if (hasDot) {
            const parts = cleaned.split('.');
            if (parts.length === 2 && parts[1].length <= 2) {
            } else {
                cleaned = cleaned.replace(/\./g, '');
            }
        }
        cleaned = cleaned.replace(/[^\d.-]/g, '');
        let amount = parseFloat(cleaned);
        if (isNaN(amount)) {
            console.warn('⚠️ No se pudo parsear importe:', amountStr);
            return null;
        }
        if (isNegative && amount > 0) {
            amount = -amount;
        }
        return amount;
    }

    generateTransactionId() {
        return 'txn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
}
    </script>
    
    <script>
// ============================================
// CHARTS.JS and RULES.JS - Continuará
// ============================================
    </script>
</body>
</html>
